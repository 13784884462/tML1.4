--- src/Terraria\Terraria.Map\MapHelper.cs
+++ src/tModLoader\Terraria.Map\MapHelper.cs
@@ -4,6 +_,8 @@
 using System.Diagnostics;
 using System.IO;
 using Terraria.IO;
+using Terraria.ModLoader;
+using Terraria.ModLoader.IO;
 using Terraria.Social;
 using Terraria.Utilities;
 
@@ -75,7 +_,8 @@
 		private static ushort dirtPosition;
 		private static ushort rockPosition;
 		private static ushort hellPosition;
+		internal static ushort modPosition;
-		private static Color[] colorLookup;
+		internal static Color[] colorLookup;
 		private static ushort[] snowTypes;
 		private static ushort wallRangeStart;
 		private static ushort wallRangeEnd;
@@ -1091,6 +_,7 @@
 
 			hellPosition = num11;
 			colorLookup[num11] = color7;
+			modPosition = (ushort)(num11 + 1);
 			snowTypes = new ushort[6];
 			snowTypes[0] = tileLookup[147];
 			snowTypes[1] = tileLookup[161];
@@ -1848,6 +_,7 @@
 			}
 
 			int num16 = num3 + num4;
+			MapLoader.ModMapOption(ref num16, i, j);
 			return MapTile.Create((ushort)num16, (byte)num2, (byte)num);
 		}
 
@@ -1887,7 +_,7 @@
 							using (DeflateStream deflateStream = new DeflateStream(memoryStream, CompressionMode.Compress)) {
 								int num = 0;
 								byte[] array = new byte[16384];
-								binaryWriter.Write(193);
+								binaryWriter.Write(194);
 								Main.MapFileMetadata.IncrementAndWrite(binaryWriter);
 								binaryWriter.Write(Main.worldName);
 								binaryWriter.Write(Main.worldID);
@@ -1975,7 +_,7 @@
 										int num5;
 										ushort num6;
 										int num7;
-										if (mapTile.Light <= 18) {
+										if (mapTile.Light <= 18 || mapTile.Type >= modPosition) {
 											flag4 = false;
 											flag3 = false;
 											num5 = 0;
@@ -2128,9 +_,12 @@
 
 								deflateStream.Dispose();
 								FileUtilities.WriteAllBytes(text, memoryStream.ToArray(), isCloudSave);
+								//patch file: text
 							}
 						}
 					}
+
+					MapIO.WriteModFile(text, isCloudSave);
 				}
 				catch (Exception value) {
 					using (StreamWriter streamWriter = new StreamWriter("client-crashlog.txt", true)) {
